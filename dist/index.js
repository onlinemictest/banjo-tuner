(()=>{function Ee(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t||alert("getUserMedia is not implemented in this browser"),new Promise(function(n,s){t.call(navigator,e,n,s)})})}var C=(e,...t)=>{e.classList.remove(...t),e.offsetWidth,e.classList.add(...t)};var xe=e=>[].concat(...e),be=(e,t)=>(e==null||e.pop(),e==null||e.unshift(t),e);var Ne=(e,t,n)=>e.reduce((s,i)=>n(i,t)<n(s,t)?i:s);var he=440,Me=69,J=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],z=xe([1,2,3,4,5,6,7,8].map(e=>J.map(t=>`${t}_${e}`)));function Te(e){let t=Re(e);return{value:t%12,index:t,name:J[t%12],cents:je(e,t),octave:Math.floor(t/12)-1,frequency:e}}function we(e){let[t,n]=e.split("_"),i=(Number(n)+1)*12+J.indexOf(t);return _e(i)}function Re(e){let t=12*(Math.log(e/he)/Math.log(2));return Math.round(t)+Me}function _e(e){return he*2**((e-Me)/12)}function je(e,t){return Math.floor(1200*Math.log(e/_e(t))/Math.log(2))}function Ye(e){return{[Symbol.iterator](){return e}}}function*Se(e,t=(n,s)=>n===s){let n=e[Symbol.iterator](),{done:s,value:i}=n.next();if(s)return;let f=[i],g=i;for(let p of Ye(n))t(p,g)?f.push(p):(yield f,f=[p]),g=p;yield f}function*Ie(e,t){for(let n of e)if(t(n))yield n;else break}var $=(e,t,n)=>e&&(e[t]=n),H=e=>!!e;function F(e,t){return new Promise(n=>e.addEventListener(t,n,{once:!0}))}var S=e=>new Promise(t=>setTimeout(t,e));var Ae=(e,t)=>{let n=!1,s;return(...i)=>{s=i,n||(t(...i),n=!0,setTimeout(()=>{n=!1,t(...s)},e))}};function I(e){return[...e].reduce((t,[n,s])=>(t[n]=s,t),{})}var Ce=(e,t=1)=>Math.round(e/t)*t,Oe=e=>Math.max(0,Math.min(1,e));console.log("Licensed under AGPL-3.0: https://github.com/onlinemictest/banjo-tuner");var Be=8192,qe=185,Ke=3500,Ve=15,We=5,l={gDGBD:["G_4","D_3","G_3","B_3","D_4"],gCGCD:["G_4","C_3","G_3","C_4","D_4"],gDGCD:["G_4","D_3","G_3","C_4","D_4"],gCGBD:["G_4","C_3","G_3","B_3","D_4"],fDFAD:["F#_4","D_3","F#_3","A_3","D_4"]},a="gDGBD",Q=!1,Ze=I(Object.entries(l).map(([e,t])=>[e,I(t.map(n=>[n,we(n)]))])),R=500,O={X:"translateX",Y:"translateY"},Je=(e,t)=>t?Ne(e,t,(n,s)=>Math.abs(z.indexOf(n)-z.indexOf(s))):void 0,ze=(e,t)=>e.indexOf(t);Ee();var Qe=e=>e[0]!==void 0,ee=3,et=e=>t=>t[0]!==e||t[0]===e&&t.length<=ee;if(!("WebAssembly"in window)||!("AudioContext"in window)||!("createAnalyser"in AudioContext.prototype)||!("createScriptProcessor"in AudioContext.prototype)){if(!("WebAssembly"in window))throw alert("Browser not supported: 'WebAssembly' is not defined");if(!("AudioContext"in window))throw alert("Browser not supported: 'AudioContext' is not defined");if(!("createAnalyser"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createAnalyser' is not defined");if(!("createScriptProcessor"in AudioContext.prototype))throw alert("Browser not supported: 'AudioContext.prototype.createScriptProcessor' is not defined")}var tt="animate"in Element.prototype?e=>e.animate([{transform:"translateY(10vw) scale(0.33)"},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>C(e,"blob-animation"),nt="animate"in Element.prototype?e=>e.animate([{transform:"translateY(-10vw) scale(3) "},{transform:"translateY(0) scale(1)"}],{duration:125,easing:"ease"}):e=>C(e,"shrink-animation"),te=e=>document.getElementById(e);Aubio().then(({Pitch:e})=>{let t=document.getElementById("banjo-tuner"),n=document.getElementById("audio-start"),s=document.getElementById("audio-pause"),i=document.getElementById("tune-up-text"),f=document.getElementById("tune-down-text"),g=document.getElementById("circle-text-play"),p=document.getElementById("circle-text-pluck"),B=document.getElementById("circle-text-complete"),L=document.getElementById("circle-text-error"),d=document.getElementById("circle-note"),b=document.getElementById("match-circle-l"),Le=document.getElementById("match-circle-r"),y=document.getElementById("inner-circle"),ne=document.getElementById("select-tuning"),T=document.getElementById("tuned-jingle");T.volume=.001;let De=.5,D=I(Object.keys(l).map(r=>[r,te(r)])),j=I(Object.entries(l).map(([r,c])=>[r,I(c.map((h,E)=>[h,te(`${r}-S${E+1}`)]))])),G=[1,2,3,4,5].map(r=>te(`S${r}-fill`));if(!t||!n||!s||!i||!f||!g||!p||!B||!L||!d||!b||!Le||!y||!ne||!T||!Object.values(D).every(H)||!Object.values(j).every(r=>Object.values(r).every(H))||!G.every(H))return alert("Expected HTML element missing");let k=Ae(500,(r,c)=>{r?(i.classList.remove("show"),f.classList.remove("show")):(i.classList[c?"add":"remove"]("show"),f.classList[c?"remove":"add"]("show"))}),v,U,N,P,Y,q;D[a].style.display="block",b.style.transform=`${O.Y}(125%)`;let oe=()=>{n.style.display="block",s.style.display="none",g.style.opacity="1",p.style.opacity="0",d.style.opacity="0",d.style.color="",b.style.transform=`${O.Y}(125%)`,i.classList.remove("show"),f.classList.remove("show"),k(!0),tt(n)};s.addEventListener("click",async()=>{clearInterval(q),oe(),await Promise.race([F(n,"animationend"),S(250)]),N.disconnect(v.destination),U.disconnect(N),v.close(),Y.getTracks().forEach(r=>r.stop())}),n.addEventListener("click",async()=>{await T.play(),await S(1600),T.volume=De},{once:!0}),ne.addEventListener("change",r=>{D[a].style.display="none",a=r.target.value,D[a].style.display="block",Object.values(j).forEach(c=>Object.values(c).forEach(h=>{var E;return $((E=h.querySelector("path"))==null?void 0:E.style,"fill","#e25c1b")})),G.forEach(c=>c.style.display="none"),Q=!0}),n.addEventListener("click",async()=>{t.scrollIntoView({behavior:"smooth",block:"center"}),n.style.display="none",s.style.display="block",nt(s),await Promise.race([F(s,"animationend"),S(250)]),v=new AudioContext,U=v.createAnalyser(),N=v.createScriptProcessor(Be,1,1),P=new e("default",Be,1,v.sampleRate),P.setSilence(-55);try{Y=await navigator.mediaDevices.getUserMedia({audio:!0}),v.createMediaStreamSource(Y).connect(U),U.connect(N),N.connect(v.destination),g.style.opacity="0",L.style.opacity="0",p.style.opacity="1";let r=!1,c=!1,h=!1,E=!1,se,u,re,ae=new Array(Ve).fill(void 0),_=new Map(l[a].map(m=>[m,[]])),M=new Map(l[a].map(m=>[m,!1])),Ge=(await F(N,"audioprocess")).inputBuffer.getChannelData(0),K=P.do(Ge);N.addEventListener("audioprocess",m=>{let w=m.inputBuffer.getChannelData(0);K=P.do(w)}),q=setInterval(()=>{var ie,le,ce,ue,de,me;if(E)return;Q&&(h=!1,u=void 0,y.style.transition="transform 100ms",y.style.transform="scale(1)",M=new Map(l[a].map(o=>[o,!1])),_=new Map(l[a].map(o=>[o,[]])),Q=!1);let m=Te(K),w=m.name?`${m.name}_${m.octave}`:void 0;be(ae,w);let V=[...Se(ae)],W=V.filter(Qe);u=Je(l[a],(ie=W.find(o=>o.length>ee))==null?void 0:ie[0]);let ke=W.every(o=>o.length<=ee),Ue=[...Ie(W,et(u))].length>=3;if(ke&&r)u=void 0,r=!1,g.style.opacity="0",p.style.opacity="1",d.style.opacity="0",d.style.color="",b.style.transform=`${O.Y}(125%)`,k(!0);else if(u&&!Number.isNaN(m.cents)&&T.paused){r=!0,c=!0;let o=u,x=Ze[a][o],pe=K<x,fe=w===o?m.cents:pe?-50:50,$e=Math.abs(fe)*2,He=Math.min(10,Math.round(100/$e)),ye=Ce(fe,He),ge=(le=_.get(o))!=null?le:[],Fe=(ce=M.get(o))!=null?ce:!1;w===o&&ye===0&&ge.push(0);let X=Oe(ge.length/We),ve=ye*(1-X);k(w===o&&ve===0,pe),p.style.opacity="0",d.style.opacity="1";let Z=o.split("_")[0];se!==Z&&(d.innerText=Z),se=Z,y.style.transition=`transform ${R}ms ease`,y.style.transform=`scale(${1-X})`,d.style.transition=`color ${R}ms ease`,d.style.color=X===1?"#fbfbfb":"#fbfbfb88",b.style.transition=`transform ${R}ms ease`,b.style.transform=`${O.Y}(${-ve}%)`,X===1&&!Fe&&($((de=(ue=j[a][o])==null?void 0:ue.querySelector("path"))==null?void 0:de.style,"fill","rgb(67,111,142)"),$((me=G[ze(l[a],o)])==null?void 0:me.style,"display","block"),M.set(o,!0),S(R).then(()=>{T.play(),C(d,"explode"),G.every(A=>A.style.display==="block")&&!h&&(h=!0,E=!0,t.classList.add("all-tuned-up"),d.style.opacity="0",B.style.opacity="1",C(B,"explode"),u=void 0,M=new Map(l[a].map(A=>[A,!1])),_=new Map(l[a].map(A=>[A,[]])),b.style.transform=`${O.Y}(125%)`,k(!0),S(Ke).then(()=>{E=!1,t.classList.remove("all-tuned-up"),B.style.opacity="0"}))}))}let Pe=V[0][0]===void 0&&V[0].length>=2,Xe=re!==u;re=u,c&&Xe?(y.style.transition="transform 100ms",y.style.transform="scale(1)",M=new Map(l[a].map(o=>{var x;return o===u?[o,(x=M.get(o))!=null?x:!1]:[o,!1]})),_=new Map(l[a].map(o=>{var x;return o===u?[o,(x=_.get(o))!=null?x:[]]:[o,[]]})),c=!1):c&&(Pe||Ue)&&(u=void 0,y.style.transition="transform 100ms",y.style.transform="scale(1)",M=new Map(l[a].map(o=>[o,!1])),_=new Map(l[a].map(o=>[o,[]])),c=!1)},qe)}catch(r){clearInterval(q),oe(),g.style.opacity="0",L.innerText=r.message,L.style.opacity="1"}})});})();
/**
 * Copyright (C) 2021 Online Mic Test
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 * @license
 */
